# üìò SQL + PostgreSQL + Python Exam Cheat Sheet

This cheat sheet is designed as a **comprehensive open-book reference** for your SQL + Python exam.  
It includes **syntax, examples, and explanations** for each topic.

---

## 1. üìÑ SQLite Basics

### Creating Tables
```sql
CREATE TABLE students (
    id INTEGER PRIMARY KEY,            -- INTEGER PK in SQLite == auto increment (ROWID)
    name TEXT NOT NULL UNIQUE,         -- cannot be NULL and must be unique
    grade REAL DEFAULT 0 CHECK(grade BETWEEN 0 AND 100)
);
```

### Insert Data
```sql
INSERT INTO students (name, grade)
VALUES ('Karin', 95);
```

### Query Data
```sql
SELECT name, grade
FROM students
WHERE grade > 80
ORDER BY grade DESC
LIMIT 5 OFFSET 2;   -- skip first 2 rows, return 5
```

### UNION vs UNION ALL
```sql
SELECT name FROM table1
UNION
SELECT name FROM table2;   -- removes duplicates

SELECT name FROM table1
UNION ALL
SELECT name FROM table2;   -- keeps duplicates
```

### Update and Delete
```sql
UPDATE students SET grade = grade + 5 WHERE id = 1;
DELETE FROM students WHERE grade < 50;
```

### Aggregates
```sql
SELECT dept, COUNT(*) AS total, AVG(grade) AS avg_grade
FROM students
GROUP BY dept
HAVING AVG(grade) > 85;
```

### Trigger Example
```sql
CREATE TRIGGER trg_after_insert
AFTER INSERT ON students
BEGIN
    INSERT INTO audit(table_name, action)
    VALUES ('students', 'insert');
END;
```

---

## 2. üêç SQLite with Python

### Connecting
```python
import sqlite3

conn = sqlite3.connect("app.db")
cur = conn.cursor()
```

### Create + Insert
```python
cur.execute("CREATE TABLE IF NOT EXISTS students(id INTEGER PRIMARY KEY, name TEXT, grade REAL)")
cur.execute("INSERT INTO students(name, grade) VALUES (?, ?)", ("Karin", 92))
conn.commit()
```

### Query
```python
cur.execute("SELECT * FROM students WHERE grade > ?", (90,))
rows = cur.fetchall()   # list of tuples
```

### Error Handling
```python
try:
    cur.execute("INSERT INTO students(name, grade) VALUES (?, ?)", ("Lior", 101))
except sqlite3.Error as e:
    print("Error:", e)
```

---

## 3. üîó SQL Relationships

### One-to-One
```sql
CREATE TABLE users(id INTEGER PRIMARY KEY, name TEXT);
CREATE TABLE passwords(
    user_id INTEGER UNIQUE,
    hash TEXT NOT NULL,
    FOREIGN KEY(user_id) REFERENCES users(id)
);
```

Query all users + passwords (if exist):
```sql
SELECT u.id, u.name, p.hash
FROM users u
LEFT JOIN passwords p ON u.id = p.user_id;
```

### One-to-Many
```sql
CREATE TABLE departments(id SERIAL PRIMARY KEY, name TEXT);
CREATE TABLE employees(
    id SERIAL PRIMARY KEY,
    name TEXT,
    dept_id INT REFERENCES departments(id)
);

-- All employees with department name
SELECT e.name, d.name
FROM employees e
LEFT JOIN departments d ON e.dept_id = d.id;
```

Departments without employees:
```sql
SELECT d.name
FROM departments d
LEFT JOIN employees e ON d.id = e.dept_id
WHERE e.id IS NULL;
```

### Many-to-Many
```sql
CREATE TABLE citizens(id SERIAL PRIMARY KEY, name TEXT);
CREATE TABLE cable_tv(id SERIAL PRIMARY KEY, company TEXT);
CREATE TABLE subscriptions(
    citizen_id INT,
    cable_id INT,
    PRIMARY KEY(citizen_id, cable_id),
    FOREIGN KEY(citizen_id) REFERENCES citizens(id),
    FOREIGN KEY(cable_id) REFERENCES cable_tv(id)
);

-- Count subscriptions per company
SELECT c.company, COUNT(*) AS subs
FROM subscriptions s
JOIN cable_tv c ON s.cable_id = c.id
GROUP BY c.company;
```

---

## 4. üêò PostgreSQL Basics

### SERIAL vs IDENTITY
```sql
id SERIAL PRIMARY KEY;
-- or modern way:
id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY;
```

### Views
```sql
CREATE VIEW top_students AS
SELECT * FROM students WHERE grade >= 90;
```

### EXPLAIN
```sql
EXPLAIN SELECT * FROM students WHERE grade > 90;
EXPLAIN ANALYZE SELECT * FROM students WHERE grade > 90;
```

### ON DELETE CASCADE
```sql
CREATE TABLE orders(
    id SERIAL PRIMARY KEY,
    customer_id INT REFERENCES customers(id) ON DELETE CASCADE
);
```

### Random + Formatting
```sql
SELECT random();   -- between 0 and 1
SELECT to_char(1234.56, 'FM9,999.00');  -- 1,234.56
```

### JSONB Example
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    profile JSONB
);

INSERT INTO users(profile) VALUES ('{"hobbies":["yoga","coding"]}');
SELECT profile->'hobbies' FROM users;
```

### Joins
- **INNER JOIN** ‚Üí only matches  
- **LEFT JOIN** ‚Üí all from left, NULL if no match  
- **FULL OUTER JOIN** ‚Üí all from both sides  
- **CROSS JOIN** ‚Üí cartesian product

---

## 5. ‚öôÔ∏è Stored Functions & Procedures

### Function Example
```sql
CREATE OR REPLACE FUNCTION greet_user(name TEXT)
RETURNS TEXT LANGUAGE plpgsql AS $$
BEGIN
    RETURN 'Hello ' || name || ' ' || NOW();
END $$;
```

### OUT Parameters
```sql
CREATE OR REPLACE FUNCTION div_mod(a INT, b INT, OUT q INT, OUT r INT)
LANGUAGE plpgsql AS $$
BEGIN
    q := a / b;
    r := a % b;
END $$;

SELECT * FROM div_mod(10, 3);  -- q=3, r=1
```

### RETURNS TABLE
```sql
CREATE OR REPLACE FUNCTION stats_books()
RETURNS TABLE(oldest INT, newest INT, avg_price NUMERIC, total INT)
LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY
    SELECT MIN(year), MAX(year), AVG(price), COUNT(*)
    FROM books;
END $$;
```

### Procedures
```sql
CREATE OR REPLACE PROCEDURE create_orders_table()
LANGUAGE plpgsql AS $$
BEGIN
    CREATE TABLE IF NOT EXISTS orders(
        id SERIAL PRIMARY KEY,
        customer TEXT,
        amount NUMERIC
    );
END $$;

CALL create_orders_table();
```

---

## 6. üêç PostgreSQL with Python (psycopg2)

### Connect
```python
import psycopg2
from psycopg2.extras import RealDictCursor

conn = psycopg2.connect(
    dbname="testdb", user="user", password="pass", host="localhost"
)
```

### Query
```python
with conn.cursor(cursor_factory=RealDictCursor) as cur:
    cur.execute("SELECT * FROM students WHERE grade > %s", (90,))
    rows = cur.fetchall()
    print(rows)
```

### Insert
```python
with conn, conn.cursor() as cur:
    cur.execute("INSERT INTO students(name, grade) VALUES (%s, %s)", ("Dana", 88))
```

### Call Procedure
```python
with conn, conn.cursor() as cur:
    cur.execute("CALL create_orders_table()")
```

---

## 7. üîÅ UPSERT (PostgreSQL)

```sql
INSERT INTO users(id, name)
VALUES (1, 'Karin')
ON CONFLICT (id) DO UPDATE
SET name = EXCLUDED.name;
```

---

## 8. üîê Transactions

### Concept
All-or-nothing group of SQL statements.

### SQL
```sql
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;   -- or ROLLBACK;
```

### Python Example
```python
try:
    with conn:
        with conn.cursor() as cur:
            cur.execute("UPDATE accounts SET balance = balance - %s WHERE id = %s", (100, 1))
            cur.execute("UPDATE accounts SET balance = balance + %s WHERE id = %s", (100, 2))
except Exception as e:
    print("Transaction failed, rolled back:", e)
```

---

# ‚úÖ Key Exam Tips

- **WHERE** filters rows before aggregation, **HAVING** filters after aggregation.  
- **UNION** removes duplicates, **UNION ALL** keeps them.  
- **ON DELETE CASCADE** automatically deletes child rows.  
- SQLite does **not** support FULL OUTER JOIN.  
- Parameters: `?` in SQLite, `%s` in psycopg2.  
- PostgreSQL: prefer `GENERATED AS IDENTITY` over `SERIAL`.  

---

Good luck! üöÄ
